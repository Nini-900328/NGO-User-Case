@{
    ViewData["Title"] = "Purchase Test";
}

<div class="container mt-4">
    <h2>Purchase Controller Test</h2>
    
    <div class="alert alert-info">
        <h4>測試用連結</h4>
        <ul>
            <li><a href="@Url.Action("Index", "Purchase")">認購頁面 (Index)</a></li>
            <li><a href="@Url.Action("Payment", "Purchase")">付款頁面 (Payment) - 應該會redirect到Index</a></li>
        </ul>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5>測試直接購買功能</h5>
        </div>
        <div class="card-body">
            <form asp-action="DirectPurchase" method="post">
                @Html.AntiForgeryToken()
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>物資ID (Supply ID)</label>
                            <input type="number" name="supplyId" value="1" class="form-control" required />
                            <small class="text-muted">測試用: 1-20 (參考 supplies.csv)</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>數量</label>
                            <input type="number" name="quantity" value="1" min="1" class="form-control" required />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>緊急需求ID (可選)</label>
                            <input type="number" name="emergencyNeedId" class="form-control" />
                            <small class="text-muted">緊急需求才填寫</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-shopping-cart me-2"></i>測試直接購買
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>系統狀態檢查</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>使用者狀態</h6>
                    <ul class="list-unstyled">
                        <li><strong>已登入:</strong> @(User.Identity?.IsAuthenticated ?? false)</li>
                        <li><strong>使用者名稱:</strong> @(User.Identity?.Name ?? "未登入")</li>
                        <li><strong>角色:</strong> @User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value</li>
                        <li><strong>NameIdentifier Claim:</strong> @User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>資料庫連接</h6>
                    <ul class="list-unstyled">
                        @if (ViewBag.DatabaseConnected == true)
                        {
                            <li><strong>狀態:</strong> <span class="text-success">已連接</span></li>
                            <li><strong>物資總數:</strong> @ViewBag.SuppliesCount</li>
                            <li><strong>用戶總數:</strong> @ViewBag.UsersCount</li>
                            <li><strong>訂單總數:</strong> @ViewBag.OrdersCount</li>
                        }
                        else
                        {
                            <li><strong>狀態:</strong> <span class="text-danger">連接失敗</span></li>
                            <li><strong>錯誤:</strong> @ViewBag.DatabaseError</li>
                        }
                        <li><strong>DbContext:</strong> NGODbContext</li>
                        <li><strong>設計模式:</strong> Entity Framework Core</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger mt-3">
            <strong>錯誤:</strong> @TempData["Error"]
        </div>
    }
    
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success mt-3">
            <strong>成功:</strong> @TempData["Success"]
        </div>
    }
</div>