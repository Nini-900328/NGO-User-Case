<!-- 使用者認購紀錄頁面 - 顯示所有物資捐贈歷史 -->
@model UserPurchaseRecordsViewModel
@{
    ViewData["Title"] = "我的認購紀錄";
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile-shared.css" />
    <link rel="stylesheet" href="~/css/purchase-records.css" />
}

<div class="container py-5">
    <!-- 頁面標題和操作按鈕 -->
    <div class="page-header mb-5">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="page-title">
                    <i class="fas fa-heart me-3"></i>我的認購紀錄
                </h2>
                <p class="page-subtitle">@Model.UserName，謝謝您用愛心溫暖了世界</p>
            </div>
            <div class="col-md-4 text-end">
                <a asp-action="UserProfile" class="btn btn-outline-primary me-2">
                    <i class="fas fa-arrow-left me-2"></i>返回個人資料
                </a>
                <a href="@Url.Action("Index", "Purchase")" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>繼續認購
                </a>
            </div>
        </div>
    </div>

    <!-- 統計卡片區 -->
    <div class="row g-4 mb-5">
        <div class="col-md-6 col-lg-3">
            <div class="stat-card donation-count">
                <div class="stat-icon">
                    <i class="fas fa-donate"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">@Model.TotalOrders</div>
                    <div class="stat-label">認購次數</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="stat-card donation-amount">
                <div class="stat-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">$@Model.TotalDonated.ToString("N0")</div>
                    <div class="stat-label">累計捐贈</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="stat-card donation-items">
                <div class="stat-icon">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">@Model.Orders.Sum(o => o.TotalItems)</div>
                    <div class="stat-label">愛心物資</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3">
            <div class="stat-card donation-families">
                <div class="stat-icon">
                    <i class="fas fa-home"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">@Model.Orders.Count(o => o.IsEmergencyOrder)</div>
                    <div class="stat-label">緊急援助</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 認購紀錄列表 -->
    <div class="records-section">
        <div class="section-header mb-4">
            <h4><i class="fas fa-list me-2"></i>認購明細</h4>
            <div class="filter-options">
                <button class="filter-btn active" data-filter="all">全部</button>
                <button class="filter-btn" data-filter="emergency">緊急援助</button>
                <button class="filter-btn" data-filter="package">組合包</button>
                <button class="filter-btn" data-filter="regular">一般認購</button>
            </div>
        </div>

        @if (Model.Orders.Any())
        {
            <div class="purchase-records">
                @foreach (var order in Model.Orders)
                {
                    <div class="purchase-record-card @(order.OrderSource switch { "emergency" => "emergency-order", "package" => "package-order", _ => "regular-order" })" 
                         data-type="@order.OrderSource">
                        
                        <!-- 訂單標題區 -->
                        <div class="record-header">
                            <div class="order-info">
                                <div class="order-number">
                                    <i class="fas fa-receipt me-2"></i>
                                    @order.OrderNumber
                                </div>
                                <div class="order-date">
                                    <i class="fas fa-calendar me-1"></i>
                                    @order.FormattedOrderDate
                                </div>
                                <div class="order-type-badge @order.OrderTypeBadgeClass">
                                    @if (order.OrderSource == "package")
                                    {
                                        <i class="fas fa-box me-1"></i>@order.OrderTypeLabel
                                    }
                                    else if (order.OrderSource == "emergency")
                                    {
                                        <i class="fas fa-exclamation-triangle me-1"></i>@order.OrderTypeLabel
                                    }
                                    else
                                    {
                                        <i class="fas fa-heart me-1"></i>@order.OrderTypeLabel
                                    }
                                </div>
                            </div>
                            <div class="order-summary">
                                <div class="summary-top">
                                    <div class="amount-display">
                                        <div class="amount-label">捐贈金額</div>
                                        <div class="amount-value">@order.FormattedTotalPrice</div>
                                    </div>
                                    <div class="status-badge @(order.PaymentStatus == "已付款" ? "status-success" : "status-pending")">
                                        <i class="fas @(order.PaymentStatus == "已付款" ? "fa-check-circle" : "fa-clock")"></i>
                                        <span>@order.PaymentStatus</span>
                                    </div>
                                </div>
                                <div class="summary-bottom">
                                    <div class="payment-method-info">
                                        <i class="fas fa-credit-card method-icon"></i>
                                        <span class="method-text">
                                            @if (!string.IsNullOrEmpty(order.PaymentMethod))
                                            {
                                                @if (order.PaymentMethod == "credit_card")
                                                {
                                                    <text>信用卡付款</text>
                                                }
                                                else if (order.PaymentMethod == "atm")
                                                {
                                                    <text>ATM轉帳</text>
                                                }
                                                else if (order.PaymentMethod == "ecpay")
                                                {
                                                    <text>綠界 ECPay</text>
                                                }
                                                else
                                                {
                                                    <text>@order.PaymentMethod</text>
                                                }
                                            }
                                            else
                                            {
                                                <text>未知付款方式</text>
                                            }
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 物資清單 -->
                        <div class="items-grid">
                            @foreach (var item in order.Items)
                            {
                                <div class="item-card">
                                    <div class="item-image">
                                        <img src="@item.ImageUrl" 
                                             alt="@item.SupplyName"
                                             onerror="this.src='/images/user-default.png'; this.onerror=null;">
                                    </div>
                                    <div class="item-details">
                                        <h6 class="item-name">@item.SupplyName</h6>
                                        <div class="item-quantity">@item.QuantityText × @item.FormattedUnitPrice</div>
                                        <div class="item-total">@item.FormattedTotalPrice</div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- 訂單底部 -->
                        <div class="record-footer">
                            <div class="impact-message">
                                <i class="fas @(order.IsEmergencyOrder ? "fa-heartbeat" : "fa-heart") me-2"></i>
                                @if (order.IsEmergencyOrder)
                                {
                                    <span>您的緊急援助為@order.TotalItems件物資提供了及時支援</span>
                                }
                                else
                                {
                                    <span>您的愛心為@order.TotalItems件物資帶來了溫暖</span>
                                }
                            </div>
                            <div class="record-actions">
                                <button class="action-btn" onclick="window.print()">
                                    <i class="fas fa-print me-1"></i>列印收據
                                </button>
                                <button class="action-btn" onclick="shareOrder('@order.OrderNumber')">
                                    <i class="fas fa-share me-1"></i>分享愛心
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- 現代化空狀態 -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <h4>還沒有認購紀錄</h4>
                <p>
                    您的愛心捐贈能為需要幫助的家庭帶來溫暖<br>
                    一起加入愛心行列，用善意點亮希望！
                </p>
                <a href="@Url.Action("Index", "Purchase")" class="btn btn-primary btn-lg">
                    <i class="fas fa-donate me-2"></i>開始認購
                </a>
            </div>
        }
    </div>
</div>

<!-- 感謝與影響力區塊 -->
@if (Model.Orders.Any())
{
    <div class="container py-5">
        <div class="gratitude-section">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="gratitude-content">
                        <i class="fas fa-hands-helping gratitude-icon"></i>
                        <h3 class="gratitude-title">感謝您的愛心</h3>
                        <p class="gratitude-message">
                            您的每一份捐贈都經過我們的專業配送，確保送達最需要的個案手中。
                            您的善舉不僅提供了物質支援，更是傳遞了社會的溫暖與關懷。
                        </p>
                        <div class="contact-info">
                            如有任何問題，歡迎隨時
                            <a href="@Url.Action("Contact", "Home")" class="contact-link">聯絡我們</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="impact-stats">
                        <div class="impact-item">
                            <div class="impact-number">100%</div>
                            <div class="impact-label">物資送達率</div>
                        </div>
                        <div class="impact-item">
                            <div class="impact-number">24h</div>
                            <div class="impact-label">緊急援助回應</div>
                        </div>
                        <div class="impact-item">
                            <div class="impact-number">@Model.Orders.Sum(o => o.TotalItems)+</div>
                            <div class="impact-label">您的愛心物資</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}


<script>
document.addEventListener('DOMContentLoaded', function() {
    // 篩選功能
    const filterButtons = document.querySelectorAll('.filter-btn');
    const recordCards = document.querySelectorAll('.purchase-record-card');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // 更新按鈕狀態
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            // 篩選記錄卡片
            recordCards.forEach(card => {
                if (filter === 'all') {
                    card.classList.remove('hidden');
                } else {
                    const type = card.dataset.type;
                    if (type === filter) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                }
            });
        });
    });
});

// 分享訂單功能
function shareOrder(orderNumber) {
    if (navigator.share) {
        navigator.share({
            title: 'NGO愛心認購',
            text: `我剛完成了一筆愛心認購（訂單：${orderNumber}），一起加入愛心行列吧！`,
            url: window.location.href
        });
    } else {
        // 備用方案：複製到剪貼板
        const text = `我剛完成了一筆愛心認購（訂單：${orderNumber}），一起加入愛心行列吧！`;
        navigator.clipboard.writeText(text).then(() => {
            alert('已複製分享內容到剪貼板！');
        });
    }
}
</script>